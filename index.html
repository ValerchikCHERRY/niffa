<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TradingNew - Инвестиционные сборки</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/luxon@3.3.0/build/global/luxon.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-luxon@1.3.1"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        /* ... (существующие стили остаются без изменений) ... */

        /* Новые стили для модального окна */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.7);
            z-index: 1000;
            align-items: center;
            justify-content: center;
        }
        
        .modal-content {
            background: var(--card-bg);
            padding: 25px;
            border-radius: 8px;
            width: 90%;
            max-width: 400px;
            box-shadow: 0 5px 30px rgba(0, 0, 0, 0.3);
        }
        
        .modal-title {
            font-size: 1.5rem;
            margin-bottom: 20px;
            text-align: center;
        }
        
        .modal-input {
            width: 100%;
            padding: 15px;
            margin-bottom: 20px;
            border-radius: 4px;
            border: 1px solid #444;
            background: var(--dark-gray);
            color: white;
            font-size: 1.2rem;
            text-align: center;
        }
        
        .modal-buttons {
            display: flex;
            gap: 15px;
        }
        
        .modal-btn {
            flex: 1;
            padding: 15px;
            border-radius: 4px;
            border: none;
            font-weight: 700;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .modal-confirm {
            background: var(--success);
            color: white;
        }
        
        .modal-cancel {
            background: var(--danger);
            color: white;
        }
    </style>
</head>
<body>
    <!-- Модальное окно для ввода суммы -->
    <div id="amountModal" class="modal">
        <div class="modal-content">
            <div class="modal-title" id="modalTitle">Replenish account</div>
            <input type="number" class="modal-input" id="amountInput" placeholder="Enter amount" min="0" step="0.01">
            <div class="modal-buttons">
                <button class="modal-btn modal-cancel" onclick="closeModal()">Cancel</button>
                <button class="modal-btn modal-confirm" onclick="confirmTransaction()">Confirm</button>
            </div>
        </div>
    </div>

    <div class="container">
        <header>
            <div class="logo">TradingNew</div>
        </header>
        
        <!-- Страница 1: Дашборд -->
        <div id="dashboard" class="page active">
            <div class="balance-container">
                <div class="balance-label">DEPOSIT VALUE</div>
                <div class="balance-row">
                    <div class="balance-value" id="balanceValue">0.00 $</div>
                    <div class="balance-change" id="balanceChange">
                        <i class="fas fa-arrow-right"></i> 0.00
                    </div>
                </div>
            </div>
            
            <div class="btn-group">
                <button class="btn btn-primary" id="replenishBtn">
                    <i class="fas fa-plus-circle"></i> Replenish
                </button>
                <button class="btn btn-success" id="withdrawBtn">
                    <i class="fas fa-wallet"></i> Withdraw
                </button>
            </div>
            
            <div class="card">
                <div class="card-title">
                    <i class="fas fa-chart-line"></i> Balance changes
                </div>
                <div class="chart-toggle" onclick="toggleChart()">
                    <i class="fas fa-eye-slash"></i> Hide the graph
                </div>
                <div class="chart-container">
                    <canvas id="balanceChart"></canvas>
                </div>
            </div>
            
            <div class="section-title">
                <i class="fas fa-folder-open"></i> Current orders
            </div>
            
            <div id="currentOrdersContainer">
                <!-- Активные ордера будут добавляться сюда динамически -->
                <div class="empty-state">
                    <div class="empty-icon">
                        <i class="fas fa-folder-open"></i>
                    </div>
                    <div class="empty-text">No active orders</div>
                </div>
            </div>
            
            <div class="section-title">
                <i class="fas fa-history"></i> Recent transactions
            </div>
            
            <div class="card" id="transactionsContainer">
                <!-- Транзакции будут добавляться сюда динамически -->
                <div class="empty-state">
                    <div class="empty-icon">
                        <i class="fas fa-exchange-alt"></i>
                    </div>
                    <div class="empty-text">No transactions yet</div>
                </div>
            </div>
        </div>
        
        <!-- Страница 2: Сборки -->
        <div id="packs" class="page">
            <div class="search-container">
                <div class="search-icon">
                    <i class="fas fa-search"></i>
                </div>
                <input type="text" class="search-input" id="searchInput" placeholder="Search orders...">
            </div>
            
            <div class="filter-panel">
                <div class="filter-grid">
                    <div class="filter-group">
                        <label class="filter-label">Expected profit (EP)</label>
                        <input type="text" class="filter-input" id="profitInput" placeholder="e.g. +$155">
                    </div>
                    
                    <div class="filter-group">
                        <label class="filter-label">Expected expiration time (EET)</label>
                        <input type="text" class="filter-input" id="termInput" placeholder="e.g. 2H 36MIN">
                    </div>
                    
                    <div class="filter-group">
                        <label class="filter-label">Bet size *</label>
                        <input type="number" class="filter-input" id="betSizeInput" placeholder="e.g. $500" min="0" step="0.01" required>
                    </div>
                    
                    <div class="filter-group">
                        <label class="filter-label">Risk level (RL)</label>
                        <select class="filter-select" id="riskSelect">
                            <option value="">Any</option>
                            <option value="low">Low</option>
                            <option value="moderate">Moderate</option>
                            <option value="high">High</option>
                        </select>
                    </div>
                </div>
                
                <button class="apply-btn" id="applyFiltersBtn">
                    <i class="fas fa-filter"></i> Apply filters
                </button>
            </div>
            
            <div class="section-title">
                <i class="fas fa-star"></i> Recommended orders
            </div>
            
            <div id="packsContainer">
                <!-- Рекомендованные сборки будут добавляться сюда после применения фильтров -->
                <div class="empty-state">
                    <div class="empty-icon">
                        <i class="fas fa-chart-line"></i>
                    </div>
                    <div class="empty-text">Apply filters to see recommended orders</div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Футер -->
    <div class="footer-nav">
        <div class="footer-nav-item active" data-page="dashboard">
            Portfolio
        </div>
        <div class="footer-nav-item" data-page="packs">
            Orders
        </div>
    </div>

    <script>
        // ======================
        // ГЛОБАЛЬНЫЕ ПЕРЕМЕННЫЕ
        // ======================
        const tg = window.Telegram?.WebApp || {
            expand: () => console.log('App expanded'),
            enableClosingConfirmation: () => console.log('Closing confirmation enabled'),
            showPopup: (options, callback) => {
                console.log('Popup shown:', options);
                callback('confirm');
            },
            openInvoice: (url) => {
                console.log('Opening invoice:', url);
                alert('Opening Telegram Wallet payment form');
            },
            showAlert: (msg) => alert(msg),
            MainButton: {
                showProgress: () => console.log('Show progress'),
                hideProgress: () => console.log('Hide progress')
            }
        };

        // Состояние приложения
        const state = {
            balance: 0,
            balanceHistory: [],
            transactions: [],
            activeOrders: [],
            currentBetSize: 0,
            packs: [
                {
                    id: "pack1",
                    metrics: {
                        ev: "+$155",
                        eet: "2H 36M",
                        rr: "2.34",
                        rl: "MODERATE"
                    },
                    assets: [
                        { symbol: "BTC", name: "Bitcoin", percentage: 30, amount: 1500 },
                        { symbol: "ETH", name: "Ethereum", percentage: 50, amount: 900 },
                        { symbol: "TSLA", name: "Tesla", percentage: 20, amount: 600 }
                    ],
                    risk: "moderate"
                },
                {
                    id: "pack2",
                    metrics: {
                        ev: "+$320",
                        eet: "8H 15M",
                        rr: "3.15",
                        rl: "HIGH"
                    },
                    assets: [
                        { symbol: "BTC", name: "Bitcoin", percentage: 40, amount: 2000 },
                        { symbol: "ETH", name: "Ethereum", percentage: 30, amount: 1500 },
                        { symbol: "AAPL", name: "Apple", percentage: 20, amount: 1000 },
                        { symbol: "SOL", name: "Solana", percentage: 10, amount: 500 }
                    ],
                    risk: "high"
                },
                {
                    id: "pack3",
                    metrics: {
                        ev: "+$98",
                        eet: "24H 00M",
                        rr: "1.75",
                        rl: "LOW"
                    },
                    assets: [
                        { symbol: "BTC", name: "Bitcoin", percentage: 20, amount: 800 },
                        { symbol: "GOLD", name: "Gold", percentage: 30, amount: 1200 },
                        { symbol: "MSFT", name: "Microsoft", percentage: 25, amount: 1000 },
                        { symbol: "BOND", name: "US Bond", percentage: 25, amount: 1000 }
                    ],
                    risk: "low"
                }
            ]
        };

        // DOM элементы
        const elements = {
            balanceValue: document.getElementById('balanceValue'),
            balanceChange: document.getElementById('balanceChange'),
            currentOrdersContainer: document.getElementById('currentOrdersContainer'),
            transactionsContainer: document.getElementById('transactionsContainer'),
            packsContainer: document.getElementById('packsContainer'),
            betSizeInput: document.getElementById('betSizeInput'),
            applyFiltersBtn: document.getElementById('applyFiltersBtn'),
            replenishBtn: document.getElementById('replenishBtn'),
            withdrawBtn: document.getElementById('withdrawBtn'),
            amountModal: document.getElementById('amountModal'),
            modalTitle: document.getElementById('modalTitle'),
            amountInput: document.getElementById('amountInput')
        };

        // Текущий тип транзакции (пополнение/вывод)
        let currentTransactionType = null;

        // ======================
        // ИНИЦИАЛИЗАЦИЯ ПРИЛОЖЕНИЯ
        // ======================
        document.addEventListener('DOMContentLoaded', function() {
            tg.expand();
            tg.enableClosingConfirmation();
            
            // Загружаем состояние из localStorage
            loadState();
            
            // Обновляем UI
            updateBalance();
            initChart();
            renderTransactions();
            renderCurrentOrders();
            
            // Инициализируем обработчики событий
            initEventListeners();
            
            // Скрываем рекомендованные сборки до применения фильтров
            elements.packsContainer.innerHTML = `
                <div class="empty-state">
                    <div class="empty-icon">
                        <i class="fas fa-chart-line"></i>
                    </div>
                    <div class="empty-text">Apply filters to see recommended orders</div>
                </div>
            `;
        });

        // ======================
        // ОБРАБОТЧИКИ СОБЫТИЙ
        // ======================
        function initEventListeners() {
            // Переключение страниц
            document.querySelectorAll('.footer-nav-item').forEach(item => {
                item.addEventListener('click', function() {
                    document.querySelectorAll('.footer-nav-item').forEach(i => i.classList.remove('active'));
                    this.classList.add('active');
                    
                    document.querySelectorAll('.page').forEach(page => page.classList.remove('active'));
                    document.getElementById(this.dataset.page).classList.add('active');
                });
            });
            
            // Кнопка применения фильтров
            elements.applyFiltersBtn.addEventListener('click', applyFilters);
            
            // Кнопки пополнения/вывода
            elements.replenishBtn.addEventListener('click', () => openModal('replenish'));
            elements.withdrawBtn.addEventListener('click', () => openModal('withdraw'));
        }

        // ======================
        // ФУНКЦИИ ДЛЯ РАБОТЫ С БАЛАНСОМ
        // ======================
        function updateBalance() {
            elements.balanceValue.textContent = formatNumber(state.balance) + " $";
            
            // Рассчитываем изменение баланса за сегодня
            const today = new Date().toISOString().split('T')[0];
            const yesterday = new Date();
            yesterday.setDate(yesterday.getDate() - 1);
            const yesterdayStr = yesterday.toISOString().split('T')[0];
            
            const todayBalance = state.balanceHistory
                .filter(entry => entry.date === today)
                .reduce((acc, entry) => entry.balance, state.balance);
            
            const yesterdayBalance = state.balanceHistory
                .filter(entry => entry.date === yesterdayStr)
                .reduce((acc, entry) => entry.balance, state.balance);
            
            const change = todayBalance - yesterdayBalance;
            
            // Обновляем элемент изменения баланса
            if (change > 0) {
                elements.balanceChange.innerHTML = `<i class="fas fa-arrow-up"></i> ${formatNumber(change)}`;
                elements.balanceChange.className = 'balance-change positive';
            } else if (change < 0) {
                elements.balanceChange.innerHTML = `<i class="fas fa-arrow-down"></i> ${formatNumber(Math.abs(change))}`;
                elements.balanceChange.className = 'balance-change negative';
            } else {
                elements.balanceChange.innerHTML = `<i class="fas fa-arrow-right"></i> 0.00`;
                elements.balanceChange.className = 'balance-change';
            }
            
            // Сохраняем состояние
            saveState();
        }

        function addBalance(amount) {
            state.balance += amount;
            addBalanceHistoryEntry();
            updateBalance();
            updateChart();
        }

        function subtractBalance(amount) {
            if (state.balance >= amount) {
                state.balance -= amount;
                addBalanceHistoryEntry();
                updateBalance();
                updateChart();
                return true;
            }
            return false;
        }

        function addBalanceHistoryEntry() {
            const now = new Date();
            const dateStr = now.toISOString().split('T')[0];
            
            // Проверяем, есть ли уже запись на сегодня
            const todayEntryIndex = state.balanceHistory.findIndex(entry => entry.date === dateStr);
            
            if (todayEntryIndex !== -1) {
                state.balanceHistory[todayEntryIndex].balance = state.balance;
            } else {
                state.balanceHistory.push({
                    date: dateStr,
                    balance: state.balance
                });
            }
        }

        // ======================
        // ФУНКЦИИ ДЛЯ ТРАНЗАКЦИЙ
        // ======================
        function addTransaction(type, amount, description = "") {
            const transaction = {
                id: Date.now(),
                type: type,
                amount: amount,
                date: new Date().toLocaleString('ru-RU', {
                    day: '2-digit',
                    month: '2-digit',
                    year: 'numeric',
                    hour: '2-digit',
                    minute: '2-digit'
                }),
                description: description
            };
            
            state.transactions.unshift(transaction);
            renderTransactions();
            saveState();
        }

        function renderTransactions() {
            if (state.transactions.length === 0) {
                elements.transactionsContainer.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-icon">
                            <i class="fas fa-exchange-alt"></i>
                        </div>
                        <div class="empty-text">No transactions yet</div>
                    </div>
                `;
                return;
            }
            
            let html = '';
            state.transactions.slice(0, 5).forEach(transaction => {
                const isPositive = transaction.type === 'deposit' || transaction.type === 'order_profit';
                const icon = isPositive ? 'fa-arrow-down' : 'fa-arrow-up';
                const sign = isPositive ? '+' : '-';
                const amountClass = isPositive ? 'positive' : 'negative';
                
                html += `
                    <div class="transaction">
                        <div class="transaction-info">
                            <div class="transaction-title">
                                <i class="fas ${icon} ${amountClass}"></i> 
                                ${getTransactionTitle(transaction.type)}
                            </div>
                            <div class="transaction-date">${transaction.date}</div>
                        </div>
                        <div class="transaction-amount ${amountClass}">${sign}$${formatNumber(Math.abs(transaction.amount))}</div>
                    </div>
                `;
            });
            
            elements.transactionsContainer.innerHTML = html;
        }

        function getTransactionTitle(type) {
            switch(type) {
                case 'deposit': return 'Replenish';
                case 'withdraw': return 'Withdrawal';
                case 'order_open': return 'Order opened';
                case 'order_close': return 'Order closed';
                case 'order_profit': return 'Order profit';
                default: return 'Transaction';
            }
        }

        // ======================
        // ФУНКЦИИ ДЛЯ ОРДЕРОВ
        // ======================
        function openOrder(packId, betSize) {
            const pack = state.packs.find(p => p.id === packId);
            if (!pack) return false;
            
            // Проверяем достаточно ли средств
            if (state.balance < betSize) {
                tg.showAlert('Insufficient funds!');
                return false;
            }
            
            // Создаем ордер
            const order = {
                id: 'ORD' + Date.now().toString().slice(-6),
                packId: packId,
                betSize: betSize,
                openDate: new Date().toLocaleString('ru-RU', {
                    day: '2-digit',
                    month: '2-digit',
                    year: 'numeric',
                    hour: '2-digit',
                    minute: '2-digit'
                }),
                status: 'active',
                metrics: { ...pack.metrics },
                assets: pack.assets.map(asset => ({
                    ...asset,
                    amount: (betSize * asset.percentage) / 100
                }))
            };
            
            // Добавляем ордер в активные
            state.activeOrders.unshift(order);
            
            // Обновляем баланс и добавляем транзакцию
            subtractBalance(betSize);
            addTransaction('order_open', betSize, `Order #${order.id}`);
            
            // Обновляем UI
            renderCurrentOrders();
            
            return true;
        }

        function renderCurrentOrders() {
            if (state.activeOrders.length === 0) {
                elements.currentOrdersContainer.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-icon">
                            <i class="fas fa-folder-open"></i>
                        </div>
                        <div class="empty-text">No active orders</div>
                    </div>
                `;
                return;
            }
            
            let html = '';
            state.activeOrders.forEach(order => {
                const pack = state.packs.find(p => p.id === order.packId);
                if (!pack) return;
                
                html += `
                    <div class="pack">
                        <div class="pack-metrics">
                            <div class="metric">
                                <span class="metric-value">${order.metrics.ev}</span>
                                <span class="metric-label">EV</span>
                            </div>
                            <div class="metric">
                                <span class="metric-value">${order.metrics.eet}</span>
                                <span class="metric-label">EET</span>
                            </div>
                            <div class="metric">
                                <span class="metric-value">${order.metrics.rr}</span>
                                <span class="metric-label">RR</span>
                            </div>
                            <div class="metric">
                                <span class="metric-value risk-badge risk-${pack.risk}">${order.metrics.rl}</span>
                                <span class="metric-label">RL</span>
                            </div>
                        </div>
                        <div class="assets-container">
                `;
                
                order.assets.forEach(asset => {
                    const gradient = getAssetGradient(asset.symbol);
                    html += `
                        <div class="asset" style="width: ${asset.percentage}%; ${gradient}">
                            <div class="asset-logo">${asset.symbol.charAt(0)}</div>
                            <div class="asset-name">${asset.symbol}</div>
                            <div class="asset-amount">$${formatNumber(asset.amount)}</div>
                        </div>
                    `;
                });
                
                html += `
                        </div>
                        <div class="pack-footer">
                            <button class="btn btn-disabled" disabled>
                                <i class="fas fa-check-circle"></i> Active ($${formatNumber(order.betSize)})
                            </button>
                        </div>
                    </div>
                `;
            });
            
            elements.currentOrdersContainer.innerHTML = html;
        }

        function getAssetGradient(symbol) {
            const gradients = {
                'BTC': 'background: linear-gradient(135deg, #f7931a, #ac6e04);',
                'ETH': 'background: linear-gradient(135deg, #627eea, #3a56c0);',
                'TSLA': 'background: linear-gradient(135deg, #e31937, #a0122a);',
                'AAPL': 'background: linear-gradient(135deg, #00aaff, #0066cc);',
                'SOL': 'background: linear-gradient(135deg, #7b68ee, #5d4ac9);',
                'GOLD': 'background: linear-gradient(135deg, #ffd700, #daa520);',
                'MSFT': 'background: linear-gradient(135deg, #00cc66, #00994d);',
                'BOND': 'background: linear-gradient(135deg, #555555, #333333);'
            };
            
            return gradients[symbol] || 'background: linear-gradient(135deg, #3498db, #2980b9);';
        }

        // ======================
        // ФУНКЦИИ ДЛЯ ФИЛЬТРОВ И СБОРОК
        // ======================
        function applyFilters() {
            const betSize = parseFloat(elements.betSizeInput.value);
            
            // Проверяем обязательное поле Bet Size
            if (!betSize || betSize <= 0) {
                tg.showAlert('Please enter a valid bet size!');
                return;
            }
            
            state.currentBetSize = betSize;
            
            // Получаем другие фильтры
            const profit = document.getElementById('profitInput').value;
            const term = document.getElementById('termInput').value;
            const risk = document.getElementById('riskSelect').value;
            
            // Фильтруем сборки
            let filteredPacks = [...state.packs];
            
            if (risk) {
                filteredPacks = filteredPacks.filter(pack => pack.risk === risk);
            }
            
            // Обновляем UI с отфильтрованными сборками
            renderPacks(filteredPacks, betSize);
        }

        function renderPacks(packs, betSize) {
            if (packs.length === 0) {
                elements.packsContainer.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-icon">
                            <i class="fas fa-ban"></i>
                        </div>
                        <div class="empty-text">No orders match your filters</div>
                    </div>
                `;
                return;
            }
            
            let html = '';
            packs.forEach(pack => {
                html += `
                    <div class="pack">
                        <div class="pack-metrics">
                            <div class="metric">
                                <span class="metric-value">${pack.metrics.ev}</span>
                                <span class="metric-label">EV</span>
                            </div>
                            <div class="metric">
                                <span class="metric-value">${pack.metrics.eet}</span>
                                <span class="metric-label">EET</span>
                            </div>
                            <div class="metric">
                                <span class="metric-value">${pack.metrics.rr}</span>
                                <span class="metric-label">RR</span>
                            </div>
                            <div class="metric">
                                <span class="metric-value risk-badge risk-${pack.risk}">${pack.metrics.rl}</span>
                                <span class="metric-label">RL</span>
                            </div>
                        </div>
                        <div class="assets-container">
                `;
                
                // Обновляем суммы в активах на основе betSize
                pack.assets.forEach(asset => {
                    const amount = (betSize * asset.percentage) / 100;
                    const gradient = getAssetGradient(asset.symbol);
                    
                    html += `
                        <div class="asset" style="width: ${asset.percentage}%; ${gradient}">
                            <div class="asset-logo">${asset.symbol.charAt(0)}</div>
                            <div class="asset-name">${asset.symbol}</div>
                            <div class="asset-amount">$${formatNumber(amount)}</div>
                        </div>
                    `;
                });
                
                html += `
                        </div>
                        <div class="pack-footer">
                            <button class="btn btn-order" data-pack-id="${pack.id}" data-bet-size="${betSize}">
                                <i class="fas fa-play-circle"></i> Open Order ($${formatNumber(betSize)})
                            </button>
                        </div>
                    </div>
                `;
            });
            
            elements.packsContainer.innerHTML = html;
            
            // Добавляем обработчики для новых кнопок
            document.querySelectorAll('.btn-order').forEach(btn => {
                btn.addEventListener('click', function() {
                    const packId = this.dataset.packId;
                    const betSize = parseFloat(this.dataset.betSize);
                    
                    tg.showPopup({
                        title: 'Confirm Order',
                        message: `Are you sure you want to open this order for $${formatNumber(betSize)}?`,
                        buttons: [{
                            id: 'confirm',
                            type: 'ok',
                            text: 'Confirm'
                        }, {
                            type: 'cancel',
                            text: 'Cancel'
                        }]
                    }, function(btnId) {
                        if (btnId === 'confirm') {
                            if (openOrder(packId, betSize)) {
                                tg.showAlert(`Order opened successfully!`);
                            }
                        }
                    });
                });
            });
        }

        // ======================
        // ФУНКЦИИ ДЛЯ ГРАФИКА
        // ======================
        let balanceChart = null;

        function initChart() {
            const ctx = document.getElementById('balanceChart').getContext('2d');
            
            // Создаем начальные данные, если история пустая
            if (state.balanceHistory.length === 0) {
                const today = new Date().toISOString().split('T')[0];
                state.balanceHistory.push({ date: today, balance: state.balance });
            }
            
            // Форматируем данные для графика
            const labels = state.balanceHistory.map(entry => entry.date);
            const data = state.balanceHistory.map(entry => entry.balance);
            
            balanceChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Balance',
                        data: data,
                        borderColor: '#3498db',
                        backgroundColor: 'rgba(52, 152, 219, 0.1)',
                        fill: true,
                        tension: 0.4,
                        pointBackgroundColor: '#3498db',
                        pointRadius: 4,
                        borderWidth: 2
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            beginAtZero: true,
                            grid: {
                                color: 'rgba(255, 255, 255, 0.1)'
                            },
                            ticks: {
                                callback: function(value) {
                                    return '$' + formatNumber(value);
                                }
                            }
                        },
                        x: {
                            grid: {
                                color: 'rgba(255, 255, 255, 0.05)'
                            }
                        }
                    },
                    plugins: {
                        legend: {
                            display: false
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    return 'Balance: $' + formatNumber(context.parsed.y);
                                }
                            }
                        }
                    }
                }
            });
        }

        function updateChart() {
            if (!balanceChart) return;
            
            // Обновляем данные графика
            const labels = state.balanceHistory.map(entry => entry.date);
            const data = state.balanceHistory.map(entry => entry.balance);
            
            balanceChart.data.labels = labels;
            balanceChart.data.datasets[0].data = data;
            balanceChart.update();
        }

        function toggleChart() {
            const chartCard = document.querySelector('.card');
            chartCard.classList.toggle('chart-hidden');
            
            const toggleBtn = document.querySelector('.chart-toggle');
            if (chartCard.classList.contains('chart-hidden')) {
                toggleBtn.innerHTML = '<i class="fas fa-eye"></i> Show graph';
            } else {
                toggleBtn.innerHTML = '<i class="fas fa-eye-slash"></i> Hide graph';
            }
        }

        // ======================
        // ФУНКЦИИ ДЛЯ МОДАЛЬНОГО ОКНА
        // ======================
        function openModal(type) {
            currentTransactionType = type;
            elements.modalTitle.textContent = type === 'replenish' 
                ? 'Replenish account' 
                : 'Withdraw funds';
            elements.amountInput.placeholder = type === 'replenish' 
                ? 'Enter amount to deposit' 
                : 'Enter amount to withdraw';
            elements.amountInput.value = '';
            elements.amountModal.style.display = 'flex';
        }

        function closeModal() {
            elements.amountModal.style.display = 'none';
            currentTransactionType = null;
        }

        function confirmTransaction() {
            const amount = parseFloat(elements.amountInput.value);
            
            if (!amount || amount <= 0) {
                tg.showAlert('Please enter a valid amount!');
                return;
            }
            
            if (currentTransactionType === 'replenish') {
                addBalance(amount);
                addTransaction('deposit', amount);
                tg.showAlert(`Successfully deposited $${formatNumber(amount)}`);
            } else if (currentTransactionType === 'withdraw') {
                if (subtractBalance(amount)) {
                    addTransaction('withdraw', -amount);
                    tg.showAlert(`Successfully withdrew $${formatNumber(amount)}`);
                } else {
                    tg.showAlert('Insufficient funds for withdrawal!');
                }
            }
            
            closeModal();
        }

        // ======================
        // ВСПОМОГАТЕЛЬНЫЕ ФУНКЦИИ
        // ======================
        function formatNumber(num) {
            return num.toFixed(2).replace(/\B(?=(\d{3})+(?!\d))/g, " ");
        }

        function saveState() {
            localStorage.setItem('tradingNewState', JSON.stringify({
                balance: state.balance,
                balanceHistory: state.balanceHistory,
                transactions: state.transactions,
                activeOrders: state.activeOrders
            }));
        }

        function loadState() {
            const savedState = localStorage.getItem('tradingNewState');
            if (savedState) {
                const parsed = JSON.parse(savedState);
                state.balance = parsed.balance || 0;
                state.balanceHistory = parsed.balanceHistory || [];
                state.transactions = parsed.transactions || [];
                state.activeOrders = parsed.activeOrders || [];
            }
        }

        // Адаптация под платформу Telegram
        if (window.Telegram && Telegram.WebApp.platform !== 'unknown') {
            document.body.style.aspectRatio = 'none';
            document.body.style.maxWidth = '100%';
            document.body.style.boxShadow = 'none';
        }
    </script>
</body>
</html>
